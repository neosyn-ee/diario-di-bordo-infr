name: Java CI with Maven
# parte solo con push o PR su master
on:
 push:
    branches: [ test/ci-cd, dev ]
 pull_request:
    branches: [ test/ci-cd, dev ]

jobs:
  test:

    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./server_test

    ###### CI ######
    steps:
    - uses: actions/checkout@v2 

    # creates environment that uses this Java 
    - name: Set up JDK
      uses: actions/setup-java@v1
      with:
        java-version: 21 # da chiedere al team backend

    - name: Validate Maven project
      run: mvn validate

    - name: Run tests
      run: mvn clean test
      continue-on-error: false  # Fail pipeline if tests fail

    - name: Build project with Maven
      run: mvn -B package --file pom.xml

    - name: Notify on failure
      if: failure() #  success() or  always()
      run: echo "Build failed! Check the logs above."
    
    - name: Change directory back
      run: cd ..
      
    ###### version control ######
    - name: Get latest tag and increment
      id: tag_version
      if: success()
      run: |
        # Get the latest tag, or use v0.0.0 if no tags exist
        LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
        echo "Latest tag: $LATEST_TAG"
        
        # Remove 'v' prefix and ...
        VERSION=${LATEST_TAG#v}
        
        # ... extract the version parts
        CURRENT_BRANCH=$"`git branch --show-current`"
        # example of a valid tag: "v2.43.0---bugfix/foo_42-bar.com"
        # gets split in 4 parts -> [2, 43, 0, bugfix/foo_42-bar.com]
        TAG_REGEX="((v?)((\.)?[0-9]+))|((\-){3}([a-zA-Z0-9\-_\./]+))"
        PARTS_SEPARATED_BY_NEWLINE=$(grep -oP "$TAG_REGEX" <<< "$VERSION")
        mapfile -t VERSION_PARTS <<< "$PARTS_SEPARATED_BY_NEWLINE"
        #cleanup
        #VERSION_PARTS[0]="${VERSION_PARTS[0]:1:99}"
        VERSION_PARTS[1]="${VERSION_PARTS[1]:1:99}"
        VERSION_PARTS[2]="${VERSION_PARTS[2]:1:99}"
        VERSION_PARTS[3]="${VERSION_PARTS[3]:3:999}"

        # Increment patch version
        PATCH="$((VERSION_PARTS[2] + 1))"
        NEW_TAG="v${VERSION_PARTS[0]}.${VERSION_PARTS[1]}.$PATCH---$CURRENT_BRANCH"
        
        echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT
        echo "New tag will be: $NEW_TAG"
    
    - name: Create and push tag
      if: success()
      run: |
        git config user.name "GitHub Actions"
        git config user.email "..." 
        git tag -a "${{ steps.tag_version.outputs.new_tag }}" -m "Release ${{ steps.tag_version.outputs.new_tag }}"
        git push origin "${{ steps.tag_version.outputs.new_tag }}"
